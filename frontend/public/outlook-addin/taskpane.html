<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Outlook CRM</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    @font-face {
      font-family: 'Monument Grotesk';
      src: url('/fonts/ABCMonumentGrotesk-Medium.woff2') format('woff2');
      font-weight: 500;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Monument Grotesk Mono';
      src: url('/fonts/ABCMonumentGroteskMono-Light.woff2') format('woff2');
      font-weight: 300;
      font-style: normal;
      font-display: swap;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Monument Grotesk', sans-serif;
      font-size: 13px;
      color: #0D0D0D;
      background: #F8F8F8;
      line-height: 1.4;
    }
    .container { padding: 16px; max-width: 100%; }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: #0D0D0D;
      color: #fff;
    }
    .header-title { font-size: 13px; letter-spacing: 0.5px; }
    .header-btn {
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 12px;
      padding: 4px 8px;
      font-family: inherit;
    }
    .header-btn:hover { color: #fff; }

    /* Login */
    .login-form { max-width: 280px; margin: 16px auto 0; }
    .login-form h2 { font-size: 16px; margin-bottom: 4px; }
    .login-form p { color: #666; font-size: 12px; margin-bottom: 20px; }

    /* Form elements */
    label {
      display: block;
      font-family: 'Monument Grotesk Mono', monospace;
      font-size: 10px;
      color: #666;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }
    input, textarea {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      background: #fff;
      transition: border-color 0.15s;
    }
    input:focus, textarea:focus { outline: none; border-color: #266A49; }
    textarea { resize: vertical; min-height: 60px; }
    .field { margin-bottom: 12px; position: relative; }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      transition: background 0.15s;
      width: 100%;
    }
    .btn-primary { background: #266A49; color: #fff; }
    .btn-primary:hover { background: #1E5539; }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
    .btn-microsoft {
      background: #fff;
      color: #0D0D0D;
      border: 1px solid #ddd;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-microsoft:hover { background: #f5f5f5; }
    .btn-microsoft:disabled { background: #f0f0f0; color: #999; cursor: not-allowed; }
    .btn-microsoft svg { flex-shrink: 0; }
    .login-divider {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 16px 0;
      font-size: 12px;
      color: #999;
    }
    .login-divider::before,
    .login-divider::after {
      content: '';
      flex: 1;
      border-top: 1px solid #e8e8e8;
    }
    .password-toggle {
      display: block;
      width: 100%;
      background: none;
      border: none;
      color: #266A49;
      font-size: 12px;
      cursor: pointer;
      padding: 4px 0;
      font-family: inherit;
      text-align: center;
    }
    .password-toggle:hover { text-decoration: underline; }
    .btn-secondary { background: #f0f0f0; color: #0D0D0D; }
    .btn-secondary:hover { background: #e4e4e4; }
    .btn-outline {
      background: none;
      border: 1px solid #ddd;
      color: #0D0D0D;
    }
    .btn-outline:hover { background: #f5f5f5; }
    .btn-sm { padding: 6px 12px; font-size: 12px; width: auto; }
    .btn-link {
      background: none;
      border: none;
      color: #266A49;
      cursor: pointer;
      font-size: 12px;
      padding: 0;
      font-family: inherit;
    }
    .btn-link:hover { text-decoration: underline; }

    /* Contact card */
    .contact-card { background: #fff; border-radius: 8px; border: 1px solid #e8e8e8; overflow: hidden; }
    .contact-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      border-bottom: 1px solid #f0f0f0;
    }
    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #e8e8e8;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      color: #666;
      flex-shrink: 0;
      overflow: hidden;
    }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    .contact-name { font-size: 15px; }
    .contact-title { font-size: 12px; color: #666; margin-top: 2px; }
    .contact-body { padding: 12px 16px; }
    .contact-field {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 6px 0;
      border-bottom: 1px solid #f5f5f5;
    }
    .contact-field:last-child { border-bottom: none; }
    .contact-field-label {
      font-family: 'Monument Grotesk Mono', monospace;
      font-size: 10px;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      min-width: 70px;
      padding-top: 2px;
    }
    .contact-field-value { font-size: 13px; text-align: right; word-break: break-word; flex: 1; margin-left: 8px; }
    .contact-field-value a { color: #266A49; text-decoration: none; }
    .contact-field-value a:hover { text-decoration: underline; }

    .contact-actions {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      border-top: 1px solid #f0f0f0;
    }

    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
    }
    .status-active { background: #e6f4ea; color: #1e7e34; }
    .status-pending { background: #fff3e0; color: #e65100; }
    .status-inactive { background: #f5f5f5; color: #666; }

    /* Edit form */
    .edit-form { padding: 16px; }
    .edit-form .field { margin-bottom: 10px; }
    .edit-actions { display: flex; gap: 8px; margin-top: 16px; }
    .edit-actions .btn { flex: 1; }

    /* States */
    .loading { text-align: center; padding: 16px; color: #666; }
    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid #e8e8e8;
      border-top-color: #266A49;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin: 0 auto 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .error-msg {
      background: #fef2f2;
      color: #c1121f;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      margin-bottom: 12px;
    }
    .success-msg {
      background: #f0fdf4;
      color: #16a34a;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      margin-bottom: 12px;
    }

    .empty-state {
      text-align: center;
      padding: 16px;
      color: #666;
    }
    .empty-state h3 { font-size: 14px; color: #0D0D0D; margin-bottom: 4px; }
    .empty-state p { font-size: 12px; margin-bottom: 16px; }

    .sender-info {
      background: #fff;
      border: 1px solid #e8e8e8;
      border-radius: 6px;
      padding: 10px 12px;
      margin-bottom: 16px;
      font-size: 12px;
    }

    .crm-link {
      display: block;
      text-align: center;
      margin-top: 12px;
      font-size: 12px;
    }
    .crm-link a { color: #266A49; text-decoration: none; }
    .crm-link a:hover { text-decoration: underline; }

    .hidden { display: none !important; }

    /* Typeahead */
    .typeahead-wrap { position: relative; }
    .typeahead-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #ddd;
      border-top: none;
      border-radius: 0 0 6px 6px;
      max-height: 180px;
      overflow-y: auto;
      z-index: 10;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .typeahead-item {
      padding: 8px 10px;
      cursor: pointer;
      font-size: 12px;
      border-bottom: 1px solid #f5f5f5;
    }
    .typeahead-item:last-child { border-bottom: none; }
    .typeahead-item:hover { background: #F8F8F8; }
    .typeahead-item-name { color: #0D0D0D; }
    .typeahead-item-detail { color: #999; font-size: 11px; margin-top: 1px; }
    .typeahead-create {
      padding: 8px 10px;
      cursor: pointer;
      font-size: 12px;
      color: #266A49;
      border-top: 1px solid #e8e8e8;
    }
    .typeahead-create:hover { background: #F8F8F8; }

    /* Section divider */
    .section-divider {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 20px 0 12px;
      font-family: 'Monument Grotesk Mono', monospace;
      font-size: 10px;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }
    .section-divider::before,
    .section-divider::after {
      content: '';
      flex: 1;
      border-top: 1px solid #e8e8e8;
    }

    /* Link to existing */
    .link-section { margin-top: 8px; }
    .link-results { margin-top: 8px; }
    .link-result-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      background: #fff;
      border: 1px solid #e8e8e8;
      border-radius: 6px;
      margin-bottom: 6px;
      cursor: pointer;
    }
    .link-result-item:hover { border-color: #266A49; }
    .link-result-name { font-size: 13px; }
    .link-result-detail { font-size: 11px; color: #999; }

    /* Org badge */
    .org-selected {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #e6f4ea;
      color: #266A49;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      margin-top: 4px;
    }
    .org-selected button {
      background: none;
      border: none;
      color: #266A49;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      padding: 0;
    }

    /* Tab toggle */
    .tab-toggle {
      display: flex;
      gap: 0;
      margin-bottom: 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
      overflow: hidden;
    }
    .tab-toggle button {
      flex: 1;
      padding: 8px 12px;
      border: none;
      background: #fff;
      font-family: inherit;
      font-size: 12px;
      cursor: pointer;
      color: #666;
    }
    .tab-toggle button.active {
      background: #266A49;
      color: #fff;
    }
    .tab-toggle button:not(:last-child) {
      border-right: 1px solid #ddd;
    }
  </style>
</head>
<body>

<div class="header">
  <span class="header-title">THE OUTLOOK CRM</span>
  <button class="header-btn hidden" id="logoutBtn" onclick="logout()">Log out</button>
</div>

<!-- Login -->
<div id="loginView" class="container">
  <div class="login-form">
    <h2>Sign in to CRM</h2>
    <p>Use your Microsoft account to sign in.</p>
    <div id="loginError" class="error-msg hidden"></div>
    <button class="btn btn-microsoft" id="ssoBtn" onclick="loginWithMicrosoft()">
      <svg width="18" height="18" viewBox="0 0 21 21" fill="none">
        <rect x="1" y="1" width="9" height="9" fill="#F25022"/>
        <rect x="11" y="1" width="9" height="9" fill="#7FBA00"/>
        <rect x="1" y="11" width="9" height="9" fill="#00A4EF"/>
        <rect x="11" y="11" width="9" height="9" fill="#FFB900"/>
      </svg>
      Sign in with Microsoft
    </button>
    <div id="passwordSection" class="hidden">
      <div class="login-divider">or</div>
      <div class="field">
        <label>Email</label>
        <input type="email" id="loginEmail" placeholder="you@example.com" autocomplete="email">
      </div>
      <div class="field">
        <label>Password</label>
        <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password">
      </div>
      <button class="btn btn-primary" id="loginBtn" onclick="login()">Sign in</button>
    </div>
    <button class="password-toggle" id="passwordToggle" onclick="togglePasswordForm()">Sign in with password instead</button>
  </div>
</div>

<!-- Loading -->
<div id="loadingView" class="container hidden">
  <div class="loading">
    <div class="spinner"></div>
    <p>Looking up contact...</p>
  </div>
</div>

<!-- Contact found -->
<div id="contactView" class="container hidden">
  <div class="contact-card">
    <div class="contact-header">
      <div class="avatar" id="contactAvatar"></div>
      <div>
        <div class="contact-name" id="contactName"></div>
        <div class="contact-title" id="contactTitle"></div>
      </div>
    </div>
    <div class="contact-body" id="contactFields"></div>
    <div class="contact-actions">
      <button class="btn btn-outline btn-sm" onclick="startEdit()">Edit</button>
      <a class="btn btn-outline btn-sm" id="crmLink" href="#" target="_blank">Open in CRM</a>
    </div>
  </div>
  <div class="crm-link" id="contactMeta"></div>
</div>

<!-- Edit contact -->
<div id="editView" class="container hidden">
  <h3 style="font-size:14px; margin-bottom:12px;">Edit contact</h3>
  <div id="editError" class="error-msg hidden"></div>
  <div id="editSuccess" class="success-msg hidden"></div>
  <div class="edit-form" id="editForm"></div>
  <div class="edit-actions">
    <button class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
    <button class="btn btn-primary" id="saveBtn" onclick="saveEdit()">Save</button>
  </div>
</div>

<!-- Contact not found -->
<div id="notFoundView" class="container hidden">
  <div class="empty-state">
    <h3>Not in CRM</h3>
    <p id="notFoundEmail"></p>
  </div>
  <div class="sender-info" id="senderInfo"></div>
  <div id="notFoundTabs">
    <div class="tab-toggle">
      <button class="active" onclick="showNotFoundTab('create')">Add to CRM</button>
      <button onclick="showNotFoundTab('link')">Link to existing</button>
    </div>
  </div>
  <div id="createSection">
    <div id="createError" class="error-msg hidden"></div>
    <div id="createForm"></div>
    <button class="btn btn-primary" id="createBtn" onclick="createContact()">Add to CRM</button>
  </div>
  <div id="linkSection" class="link-section hidden">
    <div id="linkError" class="error-msg hidden"></div>
    <div id="linkSuccess" class="success-msg hidden"></div>
    <div class="field">
      <label>Search contacts</label>
      <input type="text" id="linkSearch" placeholder="Search by name or email..." oninput="debouncedSearchContacts()">
    </div>
    <div id="linkResults" class="link-results"></div>
  </div>
</div>

<!-- No Office context (browser testing) -->
<div id="noOfficeView" class="container hidden">
  <div class="empty-state">
    <h3>Outlook Add-in</h3>
    <p>Open this in Outlook to look up email senders in the CRM.</p>
  </div>
</div>

<script>
var API_BASE = window.location.origin;
var TOKEN_KEY = 'crm_pb_token';
var USER_KEY = 'crm_pb_user';

var currentContact = null;
var senderEmail = '';
var senderName = '';
var isOfficeReady = false;
var parsedSignature = null;

// ── Office.js init ──────────────────────────────────────────────────────
function officeReady(source) {
  if (isOfficeReady) return;
  isOfficeReady = true;

  var hasMailbox = false;
  try { hasMailbox = !!(Office.context && Office.context.mailbox); } catch(e) {}

  if (hasMailbox) {
    checkAuth();
  } else {
    if (getToken()) {
      show('noOfficeView');
      document.getElementById('logoutBtn').classList.remove('hidden');
    } else {
      show('loginView');
    }
  }
}

try {
  Office.initialize = function() { officeReady('initialize'); };
  Office.onReady(function() { officeReady('onReady'); });
} catch(e) {}

var pollCount = 0;
var pollInterval = setInterval(function() {
  pollCount++;
  if (isOfficeReady) { clearInterval(pollInterval); return; }

  var hasMailbox = false;
  try { hasMailbox = !!(Office.context && Office.context.mailbox); } catch(e) {}

  if (hasMailbox) {
    clearInterval(pollInterval);
    officeReady('poll');
  } else if (pollCount >= 10) {
    clearInterval(pollInterval);
    if (getToken()) {
      show('noOfficeView');
      document.getElementById('logoutBtn').classList.remove('hidden');
    } else {
      show('loginView');
    }
  }
}, 500);

// ── Auth ────────────────────────────────────────────────────────────────
function getToken() { return localStorage.getItem(TOKEN_KEY); }
function getUser() { try { return JSON.parse(localStorage.getItem(USER_KEY)); } catch(e) { return null; } }

function togglePasswordForm() {
  var section = document.getElementById('passwordSection');
  var toggle = document.getElementById('passwordToggle');
  if (section.classList.contains('hidden')) {
    section.classList.remove('hidden');
    toggle.textContent = 'Hide password form';
  } else {
    section.classList.add('hidden');
    toggle.textContent = 'Sign in with password instead';
  }
}

function loginWithMicrosoft() {
  var btn = document.getElementById('ssoBtn');
  var errEl = document.getElementById('loginError');
  errEl.classList.add('hidden');
  btn.disabled = true;
  btn.querySelector('svg').style.display = 'none';
  btn.insertAdjacentHTML('afterbegin', '<span class="sso-spinner" style="width:16px;height:16px;border:2px solid #e8e8e8;border-top-color:#266A49;border-radius:50%;animation:spin 0.6s linear infinite;display:inline-block;"></span>');

  var dialogUrl = API_BASE + '/outlook-addin/oauth-callback.html';

  Office.context.ui.displayDialogAsync(dialogUrl, { height: 60, width: 40 }, function(result) {
    var spinner = btn.querySelector('.sso-spinner');
    if (spinner) spinner.remove();
    var svg = btn.querySelector('svg');
    if (svg) svg.style.display = '';

    if (result.status === Office.AsyncResultStatus.Failed) {
      btn.disabled = false;
      showError(errEl, 'Could not open sign-in window. Error: ' + result.error.message);
      return;
    }

    var dialog = result.value;

    dialog.addEventHandler(Office.EventType.DialogMessageReceived, function(arg) {
      dialog.close();
      btn.disabled = false;

      try {
        var message = JSON.parse(arg.message);
        if (message.type === 'oauth_success') {
          localStorage.setItem(TOKEN_KEY, message.token);
          localStorage.setItem(USER_KEY, JSON.stringify(message.user));
          document.getElementById('logoutBtn').classList.remove('hidden');
          lookupSender();
        } else {
          showError(errEl, message.error || 'Sign-in failed.');
        }
      } catch(e) {
        showError(errEl, 'Sign-in failed. Please try again.');
      }
    });

    dialog.addEventHandler(Office.EventType.DialogEventReceived, function(arg) {
      btn.disabled = false;
      if (arg.error && arg.error !== 12006) {
        showError(errEl, 'Sign-in was cancelled.');
      }
    });
  });
}

function checkAuth() {
  var token = getToken();
  if (!token) { show('loginView'); return; }

  fetch(API_BASE + '/api/contacts?search=__ping__&perPage=1', {
    headers: { 'Authorization': 'Bearer ' + token }
  }).then(function(r) {
    if (r.status === 401) {
      localStorage.removeItem(TOKEN_KEY);
      localStorage.removeItem(USER_KEY);
      show('loginView');
    } else {
      document.getElementById('logoutBtn').classList.remove('hidden');
      lookupSender();
    }
  }).catch(function() {
    show('loginView');
  });
}

function login() {
  var email = document.getElementById('loginEmail').value.trim();
  var password = document.getElementById('loginPassword').value;
  var btn = document.getElementById('loginBtn');
  var errEl = document.getElementById('loginError');

  if (!email || !password) { showError(errEl, 'Email and password are required.'); return; }

  btn.disabled = true;
  btn.textContent = 'Signing in...';
  errEl.classList.add('hidden');

  fetch(API_BASE + '/api/collections/users/auth-with-password', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ identity: email, password: password })
  })
  .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
  .then(function(res) {
    btn.disabled = false;
    btn.textContent = 'Sign in';
    if (!res.ok) {
      showError(errEl, res.data.message || 'Invalid credentials.');
      return;
    }
    localStorage.setItem(TOKEN_KEY, res.data.token);
    localStorage.setItem(USER_KEY, JSON.stringify(res.data.record));
    document.getElementById('logoutBtn').classList.remove('hidden');
    lookupSender();
  })
  .catch(function() {
    btn.disabled = false;
    btn.textContent = 'Sign in';
    showError(errEl, 'Connection failed. Check your network.');
  });
}

function logout() {
  localStorage.removeItem(TOKEN_KEY);
  localStorage.removeItem(USER_KEY);
  document.getElementById('logoutBtn').classList.add('hidden');
  currentContact = null;
  show('loginView');
}

// ── Sender lookup ───────────────────────────────────────────────────────
function lookupSender() {
  if (!isOfficeReady) return;

  try {
    var item = Office.context.mailbox.item;
    senderEmail = item.from.emailAddress;
    senderName = item.from.displayName || '';
  } catch(e) {
    show('noOfficeView');
    return;
  }

  if (!senderEmail) {
    show('noOfficeView');
    return;
  }

  show('loadingView');

  fetch(API_BASE + '/api/contacts?search=' + encodeURIComponent(senderEmail) + '&perPage=5', {
    headers: { 'Authorization': 'Bearer ' + getToken() }
  })
  .then(function(r) {
    if (r.status === 401) { logout(); return null; }
    return r.json();
  })
  .then(function(data) {
    if (!data) return;
    if (data.items && data.items.length > 0) {
      currentContact = data.items[0];
      renderContact(currentContact);
      show('contactView');
    } else {
      renderNotFound();
      show('notFoundView');
    }
  })
  .catch(function() {
    renderNotFound();
    show('notFoundView');
  });

  try {
    Office.context.mailbox.addHandlerAsync(Office.EventType.ItemChanged, function() {
      lookupSender();
    });
  } catch(e) {}
}

// ── Email signature parser ──────────────────────────────────────────────
function parseSignature(bodyText) {
  var result = { phone: '', jobTitle: '', company: '', linkedin: '', website: '' };
  if (!bodyText) return result;

  var lines = bodyText.split(/\r?\n/);

  // Find signature start: look for separator or last block of short lines
  var sigStart = -1;
  for (var i = lines.length - 1; i >= 0; i--) {
    var line = lines[i].trim();
    if (line === '--' || line === '---' || /^[-_=]{3,}$/.test(line)) {
      sigStart = i + 1;
      break;
    }
  }

  // If no separator found, take the last 15 non-empty lines
  if (sigStart === -1) {
    var nonEmpty = [];
    for (var i = lines.length - 1; i >= 0; i--) {
      if (lines[i].trim()) nonEmpty.push(i);
      if (nonEmpty.length >= 15) break;
    }
    sigStart = nonEmpty.length > 0 ? nonEmpty[nonEmpty.length - 1] : 0;
  }

  var sigLines = lines.slice(sigStart);
  var sigText = sigLines.join('\n');

  // Phone: international/AU formats
  var phoneMatch = sigText.match(/(?:\+\d[\d\s\-().]{6,14}\d|\(0\d\)\s*\d[\d\s\-]{5,10}\d|0\d[\d\s\-]{7,10}\d)/);
  if (phoneMatch) result.phone = phoneMatch[0].trim();

  // LinkedIn URL
  var linkedinMatch = sigText.match(/(?:https?:\/\/)?(?:www\.)?linkedin\.com\/in\/[\w-]+\/?/i);
  if (linkedinMatch) {
    result.linkedin = linkedinMatch[0];
    if (!/^https?:\/\//i.test(result.linkedin)) result.linkedin = 'https://' + result.linkedin;
  }

  // Website: URLs that aren't social media
  var urlRegex = /https?:\/\/[^\s<>"']+/gi;
  var urls = sigText.match(urlRegex) || [];
  for (var i = 0; i < urls.length; i++) {
    var u = urls[i].toLowerCase();
    if (u.indexOf('linkedin.com') === -1 && u.indexOf('twitter.com') === -1 &&
        u.indexOf('facebook.com') === -1 && u.indexOf('instagram.com') === -1 &&
        u.indexOf('x.com') === -1) {
      result.website = urls[i].replace(/[.,;:)\]]+$/, '');
      break;
    }
  }

  // Job title and company: look for short lines near the sender name
  var senderFirst = (senderName || '').split(/\s+/)[0].toLowerCase();
  var titleCandidates = [];
  for (var i = 0; i < sigLines.length; i++) {
    var line = sigLines[i].trim();
    if (!line || line.length > 60 || line.length < 2) continue;
    // Skip lines that look like email, phone, or URL
    if (/@/.test(line) || /https?:\/\//.test(line)) continue;
    if (/^[\d\s\-+().]+$/.test(line)) continue;
    // Skip the sender's own name line
    if (senderFirst && line.toLowerCase().indexOf(senderFirst) !== -1) continue;
    titleCandidates.push(line);
  }

  // First candidate is likely job title, second is company
  if (titleCandidates.length >= 2) {
    // If line contains a | separator, split into title | company
    var firstLine = titleCandidates[0];
    if (firstLine.indexOf('|') !== -1) {
      var parts = firstLine.split('|');
      result.jobTitle = parts[0].trim();
      result.company = parts[1].trim();
    } else if (firstLine.indexOf(',') !== -1 && firstLine.split(',').length === 2) {
      var parts = firstLine.split(',');
      result.jobTitle = parts[0].trim();
      result.company = parts[1].trim();
    } else {
      result.jobTitle = titleCandidates[0];
      result.company = titleCandidates[1];
    }
  } else if (titleCandidates.length === 1) {
    result.jobTitle = titleCandidates[0];
  }

  return result;
}

function getEmailBody(callback) {
  try {
    Office.context.mailbox.item.body.getAsync(
      Office.CoercionType.Text,
      function(asyncResult) {
        if (asyncResult.status === Office.AsyncResultStatus.Succeeded) {
          callback(asyncResult.value);
        } else {
          callback('');
        }
      }
    );
  } catch(e) {
    callback('');
  }
}

// ── Organisation search ─────────────────────────────────────────────────
var orgSearchTimer = null;

function searchOrganisations(query, callback) {
  if (!query || query.length < 2) { callback([]); return; }

  fetch(API_BASE + '/api/organisations?search=' + encodeURIComponent(query) + '&perPage=5', {
    headers: { 'Authorization': 'Bearer ' + getToken() }
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    callback(data.items || []);
  })
  .catch(function() { callback([]); });
}

function renderOrgTypeahead(inputId, hiddenId, selectedId, prefill) {
  var html = '<div class="field typeahead-wrap">';
  html += '<label>Organisation</label>';
  html += '<input type="text" id="' + inputId + '" placeholder="Search organisations..." value="' + esc(prefill || '') + '" autocomplete="off">';
  html += '<input type="hidden" id="' + hiddenId + '">';
  html += '<div id="' + inputId + '_dropdown" class="typeahead-dropdown hidden"></div>';
  html += '<div id="' + selectedId + '" class="hidden"></div>';
  html += '</div>';
  return html;
}

function setupOrgTypeahead(inputId, hiddenId, selectedId, preSelectedId, preSelectedName) {
  var input = document.getElementById(inputId);
  var hidden = document.getElementById(hiddenId);
  var dropdown = document.getElementById(inputId + '_dropdown');
  var selectedEl = document.getElementById(selectedId);

  if (preSelectedId && preSelectedName) {
    selectOrg(preSelectedId, preSelectedName);
  }

  function selectOrg(orgId, orgName) {
    hidden.value = orgId;
    input.value = '';
    input.classList.add('hidden');
    dropdown.classList.add('hidden');
    selectedEl.innerHTML = '<span class="org-selected">' + esc(orgName) +
      ' <button onclick="clearOrg(\'' + inputId + '\',\'' + hiddenId + '\',\'' + selectedId + '\')" title="Remove">&times;</button></span>';
    selectedEl.classList.remove('hidden');
  }

  input.addEventListener('input', function() {
    clearTimeout(orgSearchTimer);
    var query = input.value.trim();
    if (query.length < 2) { dropdown.classList.add('hidden'); return; }

    orgSearchTimer = setTimeout(function() {
      searchOrganisations(query, function(orgs) {
        var html = '';
        for (var i = 0; i < orgs.length; i++) {
          html += '<div class="typeahead-item" data-id="' + esc(orgs[i].id) + '" data-name="' + esc(orgs[i].name) + '">';
          html += '<div class="typeahead-item-name">' + esc(orgs[i].name) + '</div>';
          if (orgs[i].industry) html += '<div class="typeahead-item-detail">' + esc(orgs[i].industry) + '</div>';
          html += '</div>';
        }
        html += '<div class="typeahead-create" data-action="create">+ Create "' + esc(query) + '"</div>';
        dropdown.innerHTML = html;
        dropdown.classList.remove('hidden');

        // Bind click handlers
        var items = dropdown.querySelectorAll('.typeahead-item');
        for (var j = 0; j < items.length; j++) {
          items[j].addEventListener('click', function() {
            selectOrg(this.getAttribute('data-id'), this.getAttribute('data-name'));
          });
        }
        dropdown.querySelector('.typeahead-create').addEventListener('click', function() {
          createQuickOrg(query, function(org) {
            if (org) selectOrg(org.id, org.name);
          });
        });
      });
    }, 300);
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.typeahead-wrap')) {
      dropdown.classList.add('hidden');
    }
  });
}

function clearOrg(inputId, hiddenId, selectedId) {
  document.getElementById(hiddenId).value = '';
  document.getElementById(inputId).classList.remove('hidden');
  document.getElementById(inputId).value = '';
  document.getElementById(selectedId).classList.add('hidden');
  document.getElementById(selectedId).innerHTML = '';
}

function createQuickOrg(name, callback) {
  fetch(API_BASE + '/api/organisations', {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer ' + getToken(),
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ name: name })
  })
  .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
  .then(function(res) {
    if (res.ok) {
      callback(res.data);
    } else {
      callback(null);
    }
  })
  .catch(function() { callback(null); });
}

// ── Contact search (for link to existing) ───────────────────────────────
var linkSearchTimer = null;

function debouncedSearchContacts() {
  clearTimeout(linkSearchTimer);
  var query = document.getElementById('linkSearch').value.trim();
  if (query.length < 2) {
    document.getElementById('linkResults').innerHTML = '';
    return;
  }
  linkSearchTimer = setTimeout(function() {
    searchContacts(query);
  }, 300);
}

function searchContacts(query) {
  var resultsEl = document.getElementById('linkResults');
  resultsEl.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

  fetch(API_BASE + '/api/contacts?search=' + encodeURIComponent(query) + '&perPage=5', {
    headers: { 'Authorization': 'Bearer ' + getToken() }
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    var items = data.items || [];
    if (items.length === 0) {
      resultsEl.innerHTML = '<p style="font-size:12px;color:#999;text-align:center;">No contacts found</p>';
      return;
    }
    var html = '';
    for (var i = 0; i < items.length; i++) {
      var c = items[i];
      var name = c.name || ((c.first_name || '') + ' ' + (c.last_name || '')).trim();
      var detail = [c.email, c.organisation_name].filter(Boolean).join(' · ');
      html += '<div class="link-result-item" onclick="confirmLink(\'' + esc(c.id) + '\', \'' + esc(name) + '\')">';
      html += '<div><div class="link-result-name">' + esc(name) + '</div>';
      if (detail) html += '<div class="link-result-detail">' + esc(detail) + '</div>';
      html += '</div></div>';
    }
    resultsEl.innerHTML = html;
  })
  .catch(function() {
    resultsEl.innerHTML = '<p style="font-size:12px;color:#c1121f;">Search failed</p>';
  });
}

function confirmLink(contactId, contactName) {
  var errEl = document.getElementById('linkError');
  var successEl = document.getElementById('linkSuccess');
  errEl.classList.add('hidden');
  successEl.classList.add('hidden');

  if (!confirm('Add ' + senderEmail + ' as a secondary email for ' + contactName + '?')) return;

  linkToExisting(contactId);
}

function linkToExisting(contactId) {
  var errEl = document.getElementById('linkError');
  var successEl = document.getElementById('linkSuccess');

  fetch(API_BASE + '/api/contacts/' + contactId, {
    method: 'PATCH',
    headers: {
      'Authorization': 'Bearer ' + getToken(),
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ personal_email: senderEmail })
  })
  .then(function(r) {
    if (r.status === 401) { logout(); return null; }
    return r.json().then(function(d) { return { ok: r.ok, data: d }; });
  })
  .then(function(res) {
    if (!res) return;
    if (!res.ok) {
      showError(errEl, res.data.error || res.data.message || 'Failed to link contact.');
      return;
    }
    currentContact = res.data;
    renderContact(currentContact);
    show('contactView');
  })
  .catch(function() {
    showError(errEl, 'Connection failed.');
  });
}

// ── Not found tabs ──────────────────────────────────────────────────────
function showNotFoundTab(tab) {
  var buttons = document.querySelectorAll('#notFoundTabs .tab-toggle button');
  for (var i = 0; i < buttons.length; i++) {
    buttons[i].classList.toggle('active', i === (tab === 'create' ? 0 : 1));
  }
  document.getElementById('createSection').classList.toggle('hidden', tab !== 'create');
  document.getElementById('linkSection').classList.toggle('hidden', tab !== 'link');
}

// ── Render contact ──────────────────────────────────────────────────────
function renderContact(c) {
  var avatarEl = document.getElementById('contactAvatar');
  var avatarUrl = c.avatar_small_url || c.avatar_thumb_url || c.avatar_url;
  if (avatarUrl) {
    avatarEl.innerHTML = '<img src="' + esc(avatarUrl) + '" alt="">';
  } else {
    avatarEl.textContent = initials(c.name || c.first_name || '?');
  }

  document.getElementById('contactName').textContent = c.name || (c.first_name + ' ' + (c.last_name || '')).trim();

  var titleParts = [];
  if (c.job_title) titleParts.push(c.job_title);
  if (c.organisation_name) titleParts.push(c.organisation_name);
  document.getElementById('contactTitle').textContent = titleParts.join(' at ');

  var fields = [];
  if (c.email) fields.push({ label: 'Email', value: '<a href="mailto:' + esc(c.email) + '">' + esc(c.email) + '</a>' });
  if (c.personal_email) fields.push({ label: 'Personal', value: '<a href="mailto:' + esc(c.personal_email) + '">' + esc(c.personal_email) + '</a>' });
  if (c.phone) fields.push({ label: 'Phone', value: esc(c.phone) });
  if (c.mobile) fields.push({ label: 'Mobile', value: esc(c.mobile) });
  if (c.organisation_name) fields.push({ label: 'Org', value: esc(c.organisation_name) });
  if (c.linkedin) fields.push({ label: 'LinkedIn', value: '<a href="' + esc(c.linkedin) + '" target="_blank">Profile</a>' });
  if (c.location) fields.push({ label: 'Location', value: esc(c.location) });
  if (c.degrees) fields.push({ label: 'Connection', value: esc(c.degrees) });
  if (c.relationship) fields.push({ label: 'Relationship', value: renderStars(c.relationship) });

  var statusClass = c.status === 'active' ? 'status-active' : c.status === 'pending' ? 'status-pending' : 'status-inactive';
  fields.push({ label: 'Status', value: '<span class="status-badge ' + statusClass + '">' + esc(c.status || 'unknown') + '</span>' });

  if (c.notes) fields.push({ label: 'Notes', value: esc(c.notes) });

  var html = '';
  for (var i = 0; i < fields.length; i++) {
    html += '<div class="contact-field">';
    html += '<span class="contact-field-label">' + fields[i].label + '</span>';
    html += '<span class="contact-field-value">' + fields[i].value + '</span>';
    html += '</div>';
  }
  document.getElementById('contactFields').innerHTML = html;

  document.getElementById('crmLink').href = API_BASE + '/contacts/' + c.id;
  document.getElementById('contactMeta').innerHTML =
    '<span style="color:#999;font-size:11px;">Source: ' + esc(c.source || '\u2014') + ' \u00b7 Added: ' + formatDate(c.created) + '</span>';
}

// ── Edit contact ────────────────────────────────────────────────────────
function startEdit() {
  if (!currentContact) return;
  var c = currentContact;

  var html = '';
  html += fieldInput('Job title', 'edit_job_title', c.job_title || '');
  html += fieldInput('Phone', 'edit_phone', c.phone || '');
  html += fieldInput('Mobile', 'edit_mobile', c.mobile || '');
  html += fieldInput('Location', 'edit_location', c.location || '');
  html += fieldInput('LinkedIn', 'edit_linkedin', c.linkedin || '');
  html += renderOrgTypeahead('edit_org_search', 'edit_organisation_id', 'edit_org_selected', '');
  var degreesOptions = [{ value: '', label: 'None' }, { value: '1st', label: '1st' }, { value: '2nd', label: '2nd' }, { value: '3rd', label: '3rd' }];
  html += fieldSelect('Connection', 'edit_degrees', c.degrees || '', degreesOptions);
  html += fieldStarRating('Relationship', 'edit_relationship', c.relationship || 0);
  html += '<div class="field"><label>Notes</label><textarea id="edit_notes" rows="3">' + esc(c.notes || '') + '</textarea></div>';

  document.getElementById('editForm').innerHTML = html;
  document.getElementById('editError').classList.add('hidden');
  document.getElementById('editSuccess').classList.add('hidden');
  show('editView');

  // Setup org typeahead and star rating after DOM is ready
  setupOrgTypeahead('edit_org_search', 'edit_organisation_id', 'edit_org_selected',
    c.organisation || '', c.organisation_name || '');
  setupStarRating('edit_relationship');
}

function cancelEdit() {
  show('contactView');
}

function saveEdit() {
  var btn = document.getElementById('saveBtn');
  var errEl = document.getElementById('editError');
  var successEl = document.getElementById('editSuccess');

  var payload = {
    job_title: document.getElementById('edit_job_title').value.trim(),
    phone: document.getElementById('edit_phone').value.trim(),
    mobile: document.getElementById('edit_mobile').value.trim(),
    location: document.getElementById('edit_location').value.trim(),
    linkedin: document.getElementById('edit_linkedin').value.trim(),
    degrees: document.getElementById('edit_degrees').value,
    relationship: parseInt(document.getElementById('edit_relationship').value) || 0,
    notes: document.getElementById('edit_notes').value.trim()
  };

  var orgId = document.getElementById('edit_organisation_id').value;
  if (orgId) payload.organisation = orgId;

  btn.disabled = true;
  btn.textContent = 'Saving...';
  errEl.classList.add('hidden');
  successEl.classList.add('hidden');

  fetch(API_BASE + '/api/contacts/' + currentContact.id, {
    method: 'PATCH',
    headers: {
      'Authorization': 'Bearer ' + getToken(),
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(payload)
  })
  .then(function(r) {
    if (r.status === 401) { logout(); return null; }
    return r.json().then(function(d) { return { ok: r.ok, data: d }; });
  })
  .then(function(res) {
    btn.disabled = false;
    btn.textContent = 'Save';
    if (!res) return;
    if (!res.ok) {
      showError(errEl, res.data.error || res.data.message || 'Failed to update contact.');
      return;
    }
    currentContact = Object.assign(currentContact, res.data);
    renderContact(currentContact);
    show('contactView');
  })
  .catch(function() {
    btn.disabled = false;
    btn.textContent = 'Save';
    showError(errEl, 'Connection failed.');
  });
}

// ── Create contact ──────────────────────────────────────────────────────
function renderNotFound() {
  document.getElementById('notFoundEmail').textContent = senderEmail;

  var parts = parseName(senderName);
  document.getElementById('senderInfo').innerHTML =
    '<strong>' + esc(senderName || senderEmail) + '</strong><br>' + esc(senderEmail);

  // Reset tabs
  showNotFoundTab('create');

  // Parse email signature for pre-fill
  getEmailBody(function(bodyText) {
    parsedSignature = parseSignature(bodyText);
    renderCreateForm(parts, parsedSignature);
  });

  // Render form immediately with blank extra fields, update when signature parsed
  renderCreateForm(parts, null);
}

function renderCreateForm(parts, sig) {
  var s = sig || { phone: '', jobTitle: '', company: '', linkedin: '', website: '' };

  var html = '';
  html += fieldInput('First name', 'create_first_name', parts.first);
  html += fieldInput('Last name', 'create_last_name', parts.last);
  html += fieldInput('Email', 'create_email', senderEmail, true);
  html += fieldInput('Job title', 'create_job_title', s.jobTitle || '');
  html += fieldInput('Phone', 'create_phone', s.phone || '');
  html += fieldInput('Location', 'create_location', '');
  html += fieldInput('LinkedIn', 'create_linkedin', s.linkedin || '');
  html += renderOrgTypeahead('create_org_search', 'create_organisation_id', 'create_org_selected', s.company || '');

  document.getElementById('createForm').innerHTML = html;
  document.getElementById('createError').classList.add('hidden');

  // Setup org typeahead
  setupOrgTypeahead('create_org_search', 'create_organisation_id', 'create_org_selected', '', '');
}

function createContact() {
  var btn = document.getElementById('createBtn');
  var errEl = document.getElementById('createError');

  var firstName = document.getElementById('create_first_name').value.trim();
  var lastName = document.getElementById('create_last_name').value.trim();
  var email = document.getElementById('create_email').value.trim();

  if (!firstName) { showError(errEl, 'First name is required.'); return; }
  if (!email) { showError(errEl, 'Email is required.'); return; }

  var payload = {
    first_name: firstName,
    last_name: lastName,
    email: email,
    job_title: document.getElementById('create_job_title').value.trim(),
    phone: document.getElementById('create_phone').value.trim(),
    location: document.getElementById('create_location').value.trim(),
    linkedin: document.getElementById('create_linkedin').value.trim(),
    source: 'outlook-addin',
    status: 'active'
  };

  var orgId = document.getElementById('create_organisation_id').value;
  if (orgId) payload.organisation = orgId;

  btn.disabled = true;
  btn.textContent = 'Adding...';
  errEl.classList.add('hidden');

  fetch(API_BASE + '/api/contacts', {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer ' + getToken(),
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(payload)
  })
  .then(function(r) {
    if (r.status === 401) { logout(); return null; }
    return r.json().then(function(d) { return { ok: r.ok, data: d }; });
  })
  .then(function(res) {
    btn.disabled = false;
    btn.textContent = 'Add to CRM';
    if (!res) return;
    if (!res.ok) {
      showError(errEl, res.data.error || res.data.message || 'Failed to create contact.');
      return;
    }
    currentContact = res.data;
    renderContact(currentContact);
    show('contactView');
  })
  .catch(function() {
    btn.disabled = false;
    btn.textContent = 'Add to CRM';
    showError(errEl, 'Connection failed.');
  });
}

// ── Helpers ─────────────────────────────────────────────────────────────
function show(viewId) {
  var views = ['loginView', 'loadingView', 'contactView', 'editView', 'notFoundView', 'noOfficeView'];
  for (var i = 0; i < views.length; i++) {
    document.getElementById(views[i]).classList.toggle('hidden', views[i] !== viewId);
  }
}

function showError(el, msg) {
  el.textContent = msg;
  el.classList.remove('hidden');
}

function esc(str) {
  if (!str) return '';
  var div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function initials(name) {
  if (!name) return '?';
  var parts = name.trim().split(/\s+/);
  if (parts.length >= 2) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
  return parts[0][0].toUpperCase();
}

function parseName(displayName) {
  if (!displayName) return { first: '', last: '' };
  var parts = displayName.trim().split(/\s+/);
  if (parts.length === 1) return { first: parts[0], last: '' };
  return { first: parts[0], last: parts.slice(1).join(' ') };
}

function formatDate(dateStr) {
  if (!dateStr) return '\u2014';
  try {
    var d = new Date(dateStr);
    return d.toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' });
  } catch(e) { return dateStr; }
}

function fieldInput(label, id, value, readonly) {
  return '<div class="field"><label>' + label + '</label>' +
    '<input id="' + id + '" value="' + esc(value) + '"' + (readonly ? ' readonly style="background:#f5f5f5;color:#666;"' : '') + '></div>';
}

function renderStars(count) {
  var html = '';
  for (var i = 1; i <= 5; i++) {
    html += '<span style="color:' + (i <= count ? '#F59E0B' : '#ddd') + ';font-size:14px;">&#9733;</span>';
  }
  return html;
}

function fieldSelect(label, id, value, options) {
  var html = '<div class="field"><label>' + label + '</label><select id="' + id + '" style="width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:inherit;background:#fff;">';
  for (var i = 0; i < options.length; i++) {
    var opt = options[i];
    html += '<option value="' + esc(opt.value) + '"' + (opt.value === value ? ' selected' : '') + '>' + esc(opt.label) + '</option>';
  }
  html += '</select></div>';
  return html;
}

function fieldStarRating(label, id, value) {
  var html = '<div class="field"><label>' + label + '</label><div id="' + id + '_wrap" style="display:flex;gap:4px;">';
  for (var i = 1; i <= 5; i++) {
    html += '<span class="star-btn" data-value="' + i + '" style="cursor:pointer;font-size:20px;color:' + (i <= value ? '#F59E0B' : '#ddd') + ';">&#9733;</span>';
  }
  html += '</div><input type="hidden" id="' + id + '" value="' + (value || 0) + '"></div>';
  return html;
}

function setupStarRating(id) {
  var wrap = document.getElementById(id + '_wrap');
  var hidden = document.getElementById(id);
  if (!wrap) return;
  var stars = wrap.querySelectorAll('.star-btn');
  for (var i = 0; i < stars.length; i++) {
    stars[i].addEventListener('click', function() {
      var val = parseInt(this.getAttribute('data-value'));
      // Toggle off if clicking the same value
      if (parseInt(hidden.value) === val) val = 0;
      hidden.value = val;
      for (var j = 0; j < stars.length; j++) {
        stars[j].style.color = (j + 1) <= val ? '#F59E0B' : '#ddd';
      }
    });
  }
}
</script>
</body>
</html>
